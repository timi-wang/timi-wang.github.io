<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link href="/favicon.ico" rel="shortcut icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.1.3/marked.min.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/styles/github.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.0.1/highlight.min.js"></script>

    <style>
        @font-face{font-family:'Avenir Next';font-style:normal;font-weight:400;src:local('Avenir Next'),local("AvenirNext-Regular"),local("AvenirNextLTPro-Regular"),url(/fonts/full/AvenirNextLTPro-Regular.otf);}
        @font-face{font-family:'Lora';font-weight:400;src:local('Lora Italic'),url(/fonts/full/Lora-Italic.ttf)}
        @font-face{font-family:'Baskerville';font-weight:400;src:local('Baskerville Italic'),url(/fonts/full/Baskerville-Italic.ttf)}
        @font-face{font-family:'HYQiHei';font-style:normal;font-weight:400;src:local('HYQiHei'),url(/fonts/full/HYQiHei-35S.ttf)}
        @font-face{font-family:'HYKaiTiS';font-weight:400;src:local('HYKaiTiS'),url(/fonts/full/HYKaiTiS.ttf)}
        @font-face{font-family:'HYFangSongS';font-weight:400;src:local('HYFangSongS'),url(/fonts/full/HYFangSongS.ttf)}
    </style>

    <link type="text/css" rel="stylesheet" href="/common/base.css"/>
</head>
<body class="light">
    <main>
        <header id="common-header"></header>
        <script>
          fetch(`/common/header.html`)
            .then(response => response.text())
            .then(headerHtml => {
              document.querySelector("#common-header").innerHTML = headerHtml;
            }).catch(e => {
            alert(e);
          })
        </script>
        <article id="article">
            <header id="article-header">
                <h1></h1>
                <p class="extra-data"></p>
            </header>
            <div id="article-content"></div>
            <footer id="article-footer">
                <a href="<%= prev.href %>" class="hover-underline">
                    <label>Prev</label>
                    <p>上一篇</p>
                </a>
                <a href="/posts/2018/kubernetes常用配置文件" style="text-align: right" class="hover-underline">
                    <label>Next</label>
                    <p>下一篇</p>
                </a>
            </footer>
        </article>
    </main>
    <script>
      (function(){
        try {
          const searchParams = new URLSearchParams(location.search);
          const title = searchParams.get('t');  // t for title
          const year = searchParams.get('y');   // y for year
          if(!title || !year) {
            return location.href = 'https://timi-wang.github.io';
          }
          const titleString = title.replaceAll('_', ' ');
          document.querySelector('head title').innerText = titleString;
          // const prefix = location.hostname === 'localhost' ? '/blog/' : 'https://raw.githubusercontent.com/timi-wang/timi-wang.github.io/master/blog/';
          const prefix = location.hostname === 'localhost' ? '/blog/' : 'https://cdn.jsdelivr.net/gh/timi-wang/timi-wang.github.io/blog/';

          const renderMd = (mdString) => {
              const renderer = {
                heading(text, level) {
                  const escapedText = text.toLowerCase().replace(/[^\w]+/g, '-');
                  return `
                  <h${level}>
                    <a name="${escapedText}" class="anchor" href="#${escapedText}"></a>
                    ${text}
                  </h${level}>`;
                },
                code(code, infostring) {
                  const language = hljs.getLanguage(infostring) ? infostring : 'plaintext';
                  return `<pre><code class="language-${language} hljs">${hljs.highlight(code, { language }).value}</code></pre>`;
                },
                image(href, _, text) {
                  href = href.match(/^http(s):\/\//) ? href : `${prefix}${year}/${title}/${href}`;
                  return text ? `
                  <figure>
                      <img src="${href}" alt="${text}">
                      <figcaption>${text}</figcaption>
                  </figure>
                  ` : `<img src="${href}"/>`;
                }
              };
              marked.use({ renderer });
              document.querySelector('#article-content').innerHTML = marked(mdString, {breaks: true});
          };

          Promise.all([
            fetch(`${prefix}data.json`).then(response => response.json()),
            fetch(`${prefix}${year}/${title}/index.md`).then(response => response.text()),
          ]).then(res => {
            const blogData = res[0][year].filter(d => d.name === title)[0];
            const mdString = res[1];

            document.querySelector('#article-header>h1').innerText = titleString;
            document.querySelector('#article-header>.extra-data').innerText = blogData.date;
            renderMd(mdString);
          }).catch(e => {
            alert(`文章获取失败: ${e}`);
          });
        } catch(e) {
          alert(e);
        }
      })();
    </script>
</body>
</html>
